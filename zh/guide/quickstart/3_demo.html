<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="alternate" hreflang="en-us" href="https://scu-zjz.github.io/IMDLBenCo-doc/IMDLBenCo-doc/guide/quickstart/3_demo.html"><meta property="og:url" content="https://scu-zjz.github.io/IMDLBenCo-doc/IMDLBenCo-doc/zh/guide/quickstart/3_demo.html"><meta property="og:site_name" content="IMDLBenCo 文档"><meta property="og:title" content="案例三：使用benco init实现你自己的模型"><meta property="og:description" content="案例三：使用benco init实现你自己的模型 我们认为学习最快的方式就是“Learn by Doing”（边做边学），所以通过几个案例来帮助使用者快速上手。 总的来说IMDL-BenCo通过类似git、conda这样的命令行调用方式帮助你快速完成图像篡改检测科研项目的开发。如果你学过vue等前端技术，那按照vue-cli来理解IMDLBenCo的设..."><meta property="og:type" content="article"><meta property="og:image" content="https://scu-zjz.github.io/IMDLBenCo-doc/IMDLBenCo-doc/images/training/training_loss.png"><meta property="og:locale" content="zh-CN"><meta property="og:locale:alternate" content="en-US"><meta property="og:updated_time" content="2025-04-03T10:12:18.000Z"><meta property="article:modified_time" content="2025-04-03T10:12:18.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"案例三：使用benco init实现你自己的模型","image":["https://scu-zjz.github.io/IMDLBenCo-doc/IMDLBenCo-doc/images/training/training_loss.png","https://scu-zjz.github.io/IMDLBenCo-doc/IMDLBenCo-doc/images/training/pixelF1.png","https://scu-zjz.github.io/IMDLBenCo-doc/IMDLBenCo-doc/images/training/train_test_samples.png","https://scu-zjz.github.io/IMDLBenCo-doc/IMDLBenCo-doc/images/training/testing_results.png","https://scu-zjz.github.io/IMDLBenCo-doc/IMDLBenCo-doc/images/training/robustness_test_plot.png"],"dateModified":"2025-04-03T10:12:18.000Z","author":[]}</script><link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png"><link rel="manifest" href="/manifest.webmanifest"><meta name="application-name" content="IMDL-BenCo-documentation"><meta name="apple-mobile-web-app-title" content="IMDL-BenCo-documentation"><meta name="theme-color" content="#3eaf7c"><title>案例三：使用benco init实现你自己的模型 | IMDLBenCo 文档</title><meta name="description" content="案例三：使用benco init实现你自己的模型 我们认为学习最快的方式就是“Learn by Doing”（边做边学），所以通过几个案例来帮助使用者快速上手。 总的来说IMDL-BenCo通过类似git、conda这样的命令行调用方式帮助你快速完成图像篡改检测科研项目的开发。如果你学过vue等前端技术，那按照vue-cli来理解IMDLBenCo的设...">
    <link rel="preload" href="/IMDLBenCo-doc/assets/style-Dd0dO5L-.css" as="style"><link rel="stylesheet" href="/IMDLBenCo-doc/assets/style-Dd0dO5L-.css">
    <link rel="modulepreload" href="/IMDLBenCo-doc/assets/app-CCtLKDl1.js"><link rel="modulepreload" href="/IMDLBenCo-doc/assets/3_demo.html-CUlC-x4j.js"><link rel="modulepreload" href="/IMDLBenCo-doc/assets/robustness_test_plot-BrdrmNbU.js">
    <link rel="prefetch" href="/IMDLBenCo-doc/assets/index.html-D1-V_O_e.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/get-started.html-BySsCoXV.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/intro.html-CTLD3-xZ.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/index.html-Ltk5iZSH.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/get-started.html-Du-auI9f.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/framework.html-DvhtPtxk.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/introduction.html-C8ewBd5h.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/0_dataprepare.html-CSVVCvpd.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/1_model_zoo.html-D67d8n6h.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/2_load_ckpt.html-Fe24u58U.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/3_demo.html-AY7YtJwI.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/4_save_images.html-C9snfzWV.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/5_complexity.html-Cjn6yL9g.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/install.html-BA0nqygR.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/AIGCdatasets.html-BnyyaxtT.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/IMDLdatasets.html-B06hwqaK.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/benco.html-BUWKnMgN.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/general.html-BLpKSzMz.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/intro_content.html-C53QWo5o.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/intro_content.html-DzeQwkB3.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/iml_vit.html-B_a0c9AE.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/intro_content.html-CgPhG128.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/leaderboard.html-CXwkUSdN.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/mvss.html-DoyU83UI.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/trufor.html-DJaT23KN.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/intro.html-BVlSKECe.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/framework.html-DrQ5AsfQ.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/introduction.html-CL40lupl.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/0_dataprepare.html-kmkb_tBu.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/1_model_zoo.html-CENoS2PI.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/2_load_ckpt.html-C2ZvpUOp.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/4_save_images.html-CWoo8bCT.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/5_complexity.html-BbN96n_Z.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/install.html-_Y49C-Ki.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/AIGCdatasets.html-CV9Shz43.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/IMDLdatasets.html--gANHPHT.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/benco.html-DNsTNFTa.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/general.html-B7608Qus.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/intro_content.html-goNDfp2E.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/intro_content.html-Du0noCEF.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/iml_vit.html-DsR6AGho.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/intro_content.html-CYinAQrJ.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/leaderboard.html-ChHSGMHK.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/mvss.html-BLYN1at3.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/trufor.html-D9327B8y.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/404.html-Bg-7ySB5.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/index-B-M8YVCw.js" as="script"><link rel="prefetch" href="/IMDLBenCo-doc/assets/giscus-BwIGYrs0.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/IMDLBenCo-doc/zh/"><img class="vp-site-logo" src="/IMDLBenCo-doc/images/IMDL_BenCo.png" alt="IMDLBenCo 文档"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">IMDLBenCo 文档</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="指南"><span class="title">指南</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>基本信息</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/base/introduction.html" aria-label="简介"><!--[--><!--[--><!--]--><!--]-->简介<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/base/framework.html" aria-label="框架设计"><!--[--><!--[--><!--]--><!--]-->框架设计<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>快速上手</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/install.html" aria-label="安装"><!--[--><!--[--><!--]--><!--]-->安装<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/0_dataprepare.html" aria-label="数据集准备"><!--[--><!--[--><!--]--><!--]-->数据集准备<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/1_model_zoo.html" aria-label="案例一：使用Model Zoo训练复现SoTA论文"><!--[--><!--[--><!--]--><!--]-->案例一：使用Model Zoo训练复现SoTA论文<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/2_load_ckpt.html" aria-label="案例二：使用Model Zoo配合checkpoint快速测试"><!--[--><!--[--><!--]--><!--]-->案例二：使用Model Zoo配合checkpoint快速测试<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/3_demo.html" aria-label="案例三：使用benco init实现你自己的模型"><!--[--><!--[--><!--]--><!--]-->案例三：使用benco init实现你自己的模型<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/4_save_images.html" aria-label="案例四：推理并保存一个数据集的mask和label"><!--[--><!--[--><!--]--><!--]-->案例四：推理并保存一个数据集的mask和label<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/5_complexity.html" aria-label="案例五：获得模型的参数量和FLOPs"><!--[--><!--[--><!--]--><!--]-->案例五：获得模型的参数量和FLOPs<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="API文档"><span class="title">API文档</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="API文档"><span class="title">API文档</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/API/intro.html" aria-label="API文档"><!--[--><!--[--><!--]--><!--]-->API文档<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="篡改检测信息集合"><span class="title">篡改检测信息集合</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="篡改检测信息集合"><span class="title">篡改检测信息集合</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>数据集</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/data/IMDLdatasets.html" aria-label="# 篡改检测数据集索引"><!--[--><!--[--><!--]--><!--]--># 篡改检测数据集索引<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/data/AIGCdatasets.html" aria-label="AIGC生成内容数据集索引"><!--[--><!--[--><!--]--><!--]-->AIGC生成内容数据集索引<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>模型和论文</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/models/benco.html" aria-label="BenCo内实现的模型"><!--[--><!--[--><!--]--><!--]-->BenCo内实现的模型<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/models/general.html" aria-label="其他模型，算法，论文"><!--[--><!--[--><!--]--><!--]-->其他模型，算法，论文<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/IMDLBenCo-doc/guide/quickstart/3_demo.html" aria-label="English"><!--[--><!--[--><!--]--><!--]-->English<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/3_demo.html" aria-label="简体中文"><!--[--><!--[--><!--]--><!--]-->简体中文<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/scu-zjz/IMDLBenCo" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="切换颜色模式"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="指南"><span class="title">指南</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>基本信息</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/base/introduction.html" aria-label="简介"><!--[--><!--[--><!--]--><!--]-->简介<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/base/framework.html" aria-label="框架设计"><!--[--><!--[--><!--]--><!--]-->框架设计<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>快速上手</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/install.html" aria-label="安装"><!--[--><!--[--><!--]--><!--]-->安装<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/0_dataprepare.html" aria-label="数据集准备"><!--[--><!--[--><!--]--><!--]-->数据集准备<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/1_model_zoo.html" aria-label="案例一：使用Model Zoo训练复现SoTA论文"><!--[--><!--[--><!--]--><!--]-->案例一：使用Model Zoo训练复现SoTA论文<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/2_load_ckpt.html" aria-label="案例二：使用Model Zoo配合checkpoint快速测试"><!--[--><!--[--><!--]--><!--]-->案例二：使用Model Zoo配合checkpoint快速测试<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/3_demo.html" aria-label="案例三：使用benco init实现你自己的模型"><!--[--><!--[--><!--]--><!--]-->案例三：使用benco init实现你自己的模型<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/4_save_images.html" aria-label="案例四：推理并保存一个数据集的mask和label"><!--[--><!--[--><!--]--><!--]-->案例四：推理并保存一个数据集的mask和label<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/5_complexity.html" aria-label="案例五：获得模型的参数量和FLOPs"><!--[--><!--[--><!--]--><!--]-->案例五：获得模型的参数量和FLOPs<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="API文档"><span class="title">API文档</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="API文档"><span class="title">API文档</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/API/intro.html" aria-label="API文档"><!--[--><!--[--><!--]--><!--]-->API文档<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="篡改检测信息集合"><span class="title">篡改检测信息集合</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="篡改检测信息集合"><span class="title">篡改检测信息集合</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>数据集</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/data/IMDLdatasets.html" aria-label="# 篡改检测数据集索引"><!--[--><!--[--><!--]--><!--]--># 篡改检测数据集索引<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/data/AIGCdatasets.html" aria-label="AIGC生成内容数据集索引"><!--[--><!--[--><!--]--><!--]-->AIGC生成内容数据集索引<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>模型和论文</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/models/benco.html" aria-label="BenCo内实现的模型"><!--[--><!--[--><!--]--><!--]-->BenCo内实现的模型<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/models/general.html" aria-label="其他模型，算法，论文"><!--[--><!--[--><!--]--><!--]-->其他模型，算法，论文<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/IMDLBenCo-doc/guide/quickstart/3_demo.html" aria-label="English"><!--[--><!--[--><!--]--><!--]-->English<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/IMDLBenCo-doc/zh/guide/quickstart/3_demo.html" aria-label="简体中文"><!--[--><!--[--><!--]--><!--]-->简体中文<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/scu-zjz/IMDLBenCo" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">指南 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/IMDLBenCo-doc/zh/guide/base/introduction.html" aria-label="简介"><!--[--><!--[--><!--]--><!--]-->简介<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/IMDLBenCo-doc/zh/guide/base/framework.html" aria-label="框架设计"><!--[--><!--[--><!--]--><!--]-->框架设计<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">快速上手 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/IMDLBenCo-doc/zh/guide/quickstart/install.html" aria-label="安装"><!--[--><!--[--><!--]--><!--]-->安装<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/IMDLBenCo-doc/zh/guide/quickstart/0_dataprepare.html" aria-label="数据集准备"><!--[--><!--[--><!--]--><!--]-->数据集准备<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/IMDLBenCo-doc/zh/guide/quickstart/1_model_zoo.html" aria-label="案例一：使用Model Zoo训练复现SoTA论文"><!--[--><!--[--><!--]--><!--]-->案例一：使用Model Zoo训练复现SoTA论文<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/IMDLBenCo-doc/zh/guide/quickstart/2_load_ckpt.html" aria-label="案例二：使用Model Zoo配合checkpoint快速测试"><!--[--><!--[--><!--]--><!--]-->案例二：使用Model Zoo配合checkpoint快速测试<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/IMDLBenCo-doc/zh/guide/quickstart/3_demo.html" aria-label="案例三：使用benco init实现你自己的模型"><!--[--><!--[--><!--]--><!--]-->案例三：使用benco init实现你自己的模型<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/IMDLBenCo-doc/zh/guide/quickstart/4_save_images.html" aria-label="案例四：推理并保存一个数据集的mask和label"><!--[--><!--[--><!--]--><!--]-->案例四：推理并保存一个数据集的mask和label<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/IMDLBenCo-doc/zh/guide/quickstart/5_complexity.html" aria-label="案例五：获得模型的参数量和FLOPs"><!--[--><!--[--><!--]--><!--]-->案例五：获得模型的参数量和FLOPs<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="案例三-使用benco-init实现你自己的模型" tabindex="-1"><a class="header-anchor" href="#案例三-使用benco-init实现你自己的模型"><span>案例三：使用benco init实现你自己的模型</span></a></h1><p>我们认为学习最快的方式就是“Learn by Doing”（边做边学），所以通过几个案例来帮助使用者快速上手。</p><p>总的来说IMDL-BenCo通过类似<code>git</code>、<code>conda</code>这样的命令行调用方式帮助你快速完成图像篡改检测科研项目的开发。如果你学过vue等前端技术，那按照vue-cli来理解IMDLBenCo的设计范式会非常轻松。</p><p>无论如何，请先参考<a class="route-link" href="/IMDLBenCo-doc/zh/guide/quickstart/install.html">安装</a>完成IMDL-BenCo的安装。</p><div class="hint-container tip"><p class="hint-container-title">本章动机</p><p>为了确保你能灵活创建自己的模型，本章会帮你理解IMDL-BenCo的设计模式和接口范式。我们按照使用流程逐步深入介绍每个部分。</p></div><h2 id="介绍所有设计模式" tabindex="-1"><a class="header-anchor" href="#介绍所有设计模式"><span>介绍所有设计模式</span></a></h2><h3 id="生成默认脚本" tabindex="-1"><a class="header-anchor" href="#生成默认脚本"><span>生成默认脚本</span></a></h3><p>在一个干净的工作路径下，执行如下命令行指令即可生成<strong>创建自己模型并测试</strong>所需的全部脚本，作为默认指令，省略base执行的也是同样的命令。</p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-26-0" aria-selected="true">完整命令</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-26-1" aria-selected="false">简写命令</button></div><!--[--><div class="vp-tab active" id="tab-26-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">完整命令</div><!--[--><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">benco init base</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-26-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">简写命令</div><!--[--><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">benco init</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p>正常执行后会看到在当前路径下生成了如下文件，它们的用途如注释所示：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token builtin class-name">.</span></span>
<span class="line">├── balanced_dataset.json       <span class="token comment"># 存放按照Protocol-CAT组织的数据集路径</span></span>
<span class="line">├── mymodel.py                  <span class="token comment"># 核心的模型实现</span></span>
<span class="line">├── README-IMDLBenCo.md         <span class="token comment"># 一个简单的readme</span></span>
<span class="line">├── test_datasets.json          <span class="token comment"># 存放测试用的数据集路径</span></span>
<span class="line">├── test_mymodel.sh             <span class="token comment"># 传参运行测试的shell脚本</span></span>
<span class="line">├── test.py                     <span class="token comment"># 测试脚本的实际Python代码</span></span>
<span class="line">├── test_robust_mymodel.sh      <span class="token comment"># 传参运行鲁棒性测试的shell脚本</span></span>
<span class="line">├── test_robust.py              <span class="token comment"># 鲁棒性测试的实际Python代码</span></span>
<span class="line">├── train_mymodel.sh            <span class="token comment"># 传参运行的训练shell脚本</span></span>
<span class="line">└── train.py                    <span class="token comment"># 训练脚本的实际Python代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">特别注意</p><p>如果已经生成过脚本，并且做出一定修改后，请一定<strong>小心二次调用</strong><code>benco init</code>，IMDLBenCo会在询问后逐一覆盖文件，如果误操作可能导致丢失你已有的修改，务必小心。推荐使用git版本管理来避免该操作导致丢失已有代码。</p></div><h3 id="模型文件设计范式" tabindex="-1"><a class="header-anchor" href="#模型文件设计范式"><span>模型文件设计范式</span></a></h3><p>IMDLBenCo需要按照一定格式组织模型文件，以保证入口可以和<code>DataLoader</code>、出口可以和后续的<code>Evaluator</code>和<code>Visualize tools</code>对齐。</p><p>执行<code>benco init</code>后默认以最简单的<strong>单层卷积</strong>生成一个模型在<code>mymodel.py</code>中，你可以先通过<a href="https://github.com/scu-zjz/IMDLBenCo/blob/main/IMDLBenCo/statics/base/mymodel.py" target="_blank" rel="noopener noreferrer">Github中的mymodel.py链接</a>快速查看它的内容。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> IMDLBenCo<span class="token punctuation">.</span>registry <span class="token keyword">import</span> MODELS</span>
<span class="line"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn</span>
<span class="line"><span class="token keyword">import</span> torch</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@MODELS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyModel</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> MyModel_Customized_param<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">,</span> pre_trained_weights<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">        The parameters of the `__init__` function will be automatically converted into the parameters expected by the argparser in the training and testing scripts by the framework according to their annotated types and variable names. </span>
<span class="line">        </span>
<span class="line">        In other words, you can directly pass in parameters with the same names and types from the `run.sh` script to initialize the model.</span>
<span class="line">        &quot;&quot;&quot;</span></span>
<span class="line">        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># Useless, just an example</span></span>
<span class="line">        self<span class="token punctuation">.</span>MyModel_Customized_param <span class="token operator">=</span> MyModel_Customized_param</span>
<span class="line">        self<span class="token punctuation">.</span>pre_trained_weights <span class="token operator">=</span> pre_trained_weights</span>
<span class="line"></span>
<span class="line">        <span class="token comment"># A single layer conv2d </span></span>
<span class="line">        self<span class="token punctuation">.</span>demo_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span></span>
<span class="line">            in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">            out_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">            kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">            stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">            padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># A simple loss</span></span>
<span class="line">        self<span class="token punctuation">.</span>loss_func_a <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># simple forwarding</span></span>
<span class="line">        pred_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>demo_layer<span class="token punctuation">(</span>image<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># simple loss</span></span>
<span class="line">        loss_a <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_func_a<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> mask<span class="token punctuation">)</span></span>
<span class="line">        loss_b <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>pred_mask <span class="token operator">-</span> mask<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        combined_loss <span class="token operator">=</span> loss_a <span class="token operator">+</span> loss_b</span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line">        pred_label <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>pred_mask<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        inverse_mask <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> mask</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># ----------Output interface--------------------------------------</span></span>
<span class="line">        output_dict <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment"># loss for backward</span></span>
<span class="line">            <span class="token string">&quot;backward_loss&quot;</span><span class="token punctuation">:</span> combined_loss<span class="token punctuation">,</span></span>
<span class="line">            <span class="token comment"># predicted mask, will calculate for metrics automatically</span></span>
<span class="line">            <span class="token string">&quot;pred_mask&quot;</span><span class="token punctuation">:</span> pred_mask<span class="token punctuation">,</span></span>
<span class="line">            <span class="token comment"># predicted binaray label, will calculate for metrics automatically</span></span>
<span class="line">            <span class="token string">&quot;pred_label&quot;</span><span class="token punctuation">:</span> pred_label<span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment"># ----values below is for visualization----</span></span>
<span class="line">            <span class="token comment"># automatically visualize with the key-value pairs</span></span>
<span class="line">            <span class="token string">&quot;visual_loss&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment"># keys here can be customized by yourself.</span></span>
<span class="line">                <span class="token string">&quot;predict_loss&quot;</span><span class="token punctuation">:</span> combined_loss<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;loss_a&#39;</span> <span class="token punctuation">:</span> loss_a<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;I am loss_b :)&quot;</span><span class="token punctuation">:</span> loss_b<span class="token punctuation">,</span> </span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">            <span class="token string">&quot;visual_image&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment"># keys here can be customized by yourself.</span></span>
<span class="line">                <span class="token comment"># Various intermediate masks, heatmaps, and feature maps can be appropriately converted into RGB or single-channel images for visualization here.</span></span>
<span class="line">                <span class="token string">&quot;pred_mask&quot;</span><span class="token punctuation">:</span> pred_mask<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;reverse_mask&quot;</span> <span class="token punctuation">:</span> inverse_mask<span class="token punctuation">,</span> </span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token comment"># -------------------------------------------------------------</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> output_dict</span>
<span class="line">    </span>
<span class="line">    </span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>MODELS<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>按照代码从前到后的顺序介绍，IMDLBenCo的model文件需要满足以下设计才能正常运行：</strong></p><ul><li>第5行：<code>@MODELS.register_module()</code><ul><li>基于注册机制注册该模型到IMDLBenCo的全局注册器中，便于其他脚本通过字符串快速调用该类。</li><li>如果对注册机制不熟悉，一句话解释就是：<strong>自动维护了一个从字符串到对应类的字典映射</strong>，便于“自由地”传递参数。</li><li>实际使用时，通过向启动训练的shell脚本的<code>--model</code>函数传入注册过的“类名同名字符串”即可使得框架加载对应的自定义or框架内已有模型。具体请参考<a href="https://github.com/scu-zjz/IMDLBenCo/blob/4c6a2937c3cae8d6ff26bf85e9bad0c5ec467468/IMDLBenCo/statics/model_zoo/runs/demo_train_mvss.sh#L10" target="_blank" rel="noopener noreferrer">此链接</a>。</li></ul></li><li>第29行、第37行：<strong>损失函数必须定义在<code>__init__()</code>或者<code>forward()</code>函数中</strong></li><li>第31行：定义forward函数时<code>def forward(self, image, mask, label, *args, **kwargs):</code><ul><li>必须要带Python函数解包所需的<code>*args, **kwargs</code>，以接收未使用的参数。 <ul><li>如果你不熟悉请参考<a href="https://docs.python.org/3/tutorial/controlflow.html#keyword-arguments" target="_blank" rel="noopener noreferrer">Python官方文档-4.8.2. Keyword Arguments</a>，<a href="https://docs.python.org/zh-cn/3/tutorial/controlflow.html#keyword-arguments" target="_blank" rel="noopener noreferrer">Python官方文档中文版-4.8.2 关键字参数</a></li></ul></li><li>形参变量名必须与<a href="https://github.com/scu-zjz/IMDLBenCo/blob/main/IMDLBenCo/datasets/abstract_dataset.py" target="_blank" rel="noopener noreferrer"><code>abstract_dataset.py</code></a>中返回的字典<code>data_dict</code>包含的字段名完全一致。默认字段如下表所示： <ul><li><table><thead><tr><th style="text-align:center;">Key名</th><th>含义</th><th style="text-align:center;">类型</th></tr></thead><tbody><tr><td style="text-align:center;">image</td><td>输入的原始图片</td><td style="text-align:center;">Tensor(B,3,H,W)</td></tr><tr><td style="text-align:center;">mask</td><td>预测目标的掩码</td><td style="text-align:center;">Tensor(B,1,H,W)</td></tr><tr><td style="text-align:center;">edge_mask</td><td>根据mask进行<a href="https://docs.opencv.org/3.4/db/df6/tutorial_erosion_dilatation.html" target="_blank" rel="noopener noreferrer">腐蚀（erosion）与膨胀（dilation）</a>后获得的仅有边界为白色的mask，以供各种需要边界损失函数的模型使用。为了减轻计算开销，必须在训练<code>shell</code>中传入<code>--edge_mask_width 7</code>这样的参数后，对应的dataloader才会返回这个键值对供模型的<code>forward()</code>函数取用，参考<code>IML-ViT</code>的<a href="https://github.com/scu-zjz/IMDLBenCo/blob/4c6a2937c3cae8d6ff26bf85e9bad0c5ec467468/IMDLBenCo/statics/model_zoo/runs/demo_train_iml_vit.sh#L22" target="_blank" rel="noopener noreferrer">shell</a>和<a href="https://github.com/scu-zjz/IMDLBenCo/blob/4c6a2937c3cae8d6ff26bf85e9bad0c5ec467468/IMDLBenCo/model_zoo/iml_vit/iml_vit.py#L125" target="_blank" rel="noopener noreferrer">模型forward函数</a>函数。<br>如果不需要边界mask来计算后续损失，则既不需要在shell中传入，也不需要在模型的<code>forward()</code>函数形参中准备名为<code>edge_mask</code>的形参，参考<code>ObjectFormer</code>的<a href="https://github.com/scu-zjz/IMDLBenCo/blob/main/IMDLBenCo/statics/model_zoo/runs/demo_train_object_former.sh" target="_blank" rel="noopener noreferrer">shell</a>和<a href="https://github.com/scu-zjz/IMDLBenCo/blob/4c6a2937c3cae8d6ff26bf85e9bad0c5ec467468/IMDLBenCo/model_zoo/object_former/object_former.py#L285" target="_blank" rel="noopener noreferrer">模型forward函数</a>。</td><td style="text-align:center;">Tensor(B,1,H,W)</td></tr><tr><td style="text-align:center;">lable</td><td>Image-level预测的零一标签</td><td style="text-align:center;">Tensor(B,1)</td></tr><tr><td style="text-align:center;">shape</td><td>经过padding或resize后，传入模型训练的图片的形状</td><td style="text-align:center;">Tensor(B,2), 两个维度各一个值，分别代表H和W</td></tr><tr><td style="text-align:center;">original_shape</td><td>最开始读取输入的图片的形状</td><td style="text-align:center;">Tensor(B,2), 两个维度各一个值，分别代表H和W</td></tr><tr><td style="text-align:center;">name</td><td>图片的路径和文件名</td><td style="text-align:center;">str</td></tr><tr><td style="text-align:center;">shape_mask</td><td>在padding的情况下，仅计算该mask内为1的全部像素作为最终指标，1默认为和原图一样大的方形区域</td><td style="text-align:center;">Tensor(B,1,H,W)</td></tr></tbody></table></li><li>对于不同的任务，可以按需取用这些字段输入到模型中使用。</li><li>此外，对于CAT-Net需要的Jpeg相关的图片素材，我们设计了后处理函数<code>post_func</code>来根据已有的字段，生成更多需要的内容，此时也需要保证对应的forward函数的字段对齐。<strong>有类似需求的自定义模型也可以使用这个范式来在dataloader引入其他模态的信息。</strong> 以下是CAT-Net的案例： <ul><li><a href="https://github.com/scu-zjz/IMDLBenCo/blob/c2d6dc03eab3f33461690d5026b43afdac22f70c/IMDLBenCo/model_zoo/cat_net/cat_net_post_function.py#L7-L10" target="_blank" rel="noopener noreferrer"><code>cat_net_post_function</code>的Github链接</a>，可以看到包含额外的<code>DCT_coef</code>和<code>q_tables</code>两个字段为模型输入额外的模态</li><li><a href="https://github.com/scu-zjz/IMDLBenCo/blob/c2d6dc03eab3f33461690d5026b43afdac22f70c/IMDLBenCo/model_zoo/cat_net/cat_net.py#L30" target="_blank" rel="noopener noreferrer"><code>cat_net_model</code>的Github链接</a>，<code>forward</code>函数的形参列表需要有相应字段接收上述额外输入的信息。</li></ul></li></ul></li></ul></li><li>第36行到第38行：所有的损失函数必须在<code>forward</code>函数中完成计算</li><li>第45行到第70行：输出结果的字典。<span style="color:red;font-weight:bold;">非常重要！</span>，字典各字段的功能介绍如下： <ul><li><table><thead><tr><th style="text-align:center;">Key</th><th style="text-align:center;">含义</th><th style="text-align:center;">类型</th></tr></thead><tbody><tr><td style="text-align:center;">backward_loss</td><td style="text-align:center;">直接用于反向传播的损失函数</td><td style="text-align:center;">Tensor(1)</td></tr><tr><td style="text-align:center;">pred_mask</td><td style="text-align:center;">预测的mask，会直接用于后续指标计算</td><td style="text-align:center;">Tensor(B,1,H,W)</td></tr><tr><td style="text-align:center;">pred_label</td><td style="text-align:center;">预测的零一标签，会直接用于后续指标计算</td><td style="text-align:center;">Tensor(B,1)</td></tr><tr><td style="text-align:center;">visual_loss</td><td style="text-align:center;">传入需要可视化的标量。可以命名任意数量、任意名称的key并传入相应标量，后续会自动根据Key名进行可视化</td><td style="text-align:center;">Dict()</td></tr><tr><td style="text-align:center;">visual_imagwe</td><td style="text-align:center;">传入需要可视化的图片，特征图，各种mask。可以命名任意数量，任意名称的key并传入相应Tensor，后续会自动根据Key名进行可视化</td><td style="text-align:center;">Dict()</td></tr></tbody></table></li><li>务必按照此格式组织，才能正常融入后续指标运算、可视化等流程。</li></ul></li></ul><h2 id="从头到尾的保姆级教程" tabindex="-1"><a class="header-anchor" href="#从头到尾的保姆级教程"><span>从头到尾的保姆级教程</span></a></h2><p>我们以<a href="https://arxiv.org/abs/2201.03545" target="_blank" rel="noopener noreferrer">ConvNeXt网络</a>为模型，CASIAv2作为训练集，CASIAv1作为测试集为例，从头到尾带您体验使用IMDL-BenCo设计，训练，测试一个您自己的新模型的流程。</p><h3 id="下载数据集" tabindex="-1"><a class="header-anchor" href="#下载数据集"><span>下载数据集</span></a></h3><p>本仓库提供了目前主流篡改检测数据集的索引目录，简介，以及勘误。请参考<a class="route-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/data/IMDLdatasets.html">篡改检测数据集索引</a>章节。</p><div class="hint-container important"><p class="hint-container-title">提示</p><p>目前很多篡改检测数据集都是纯手工标注收集，导致存在很多错误，所以必要的勘误是必须的。常见错误包括：</p><ol><li>image和mask分辨率不一致；</li><li>有多余图片没有对应mask；</li><li>image和mask有显然的错位标注；</li></ol><p>更多勘误相关信息可以参考这个<a href="https://github.com/SunnyHaze/IML-Dataset-Corrections" target="_blank" rel="noopener noreferrer">IML-Dataset-Corrections仓库</a>。</p></div><ul><li>CASIAv2下载链接： <ul><li>请参考<a href="https://github.com/SunnyHaze/CASIA2.0-Corrected-Groundtruth" target="_blank" rel="noopener noreferrer">Sunnyhaze的仓库</a>的<code>Fixed groundtruth downloading</code>章节下载完整数据集。</li></ul></li><li>CASIAv1下载链接： <ul><li>请从<a href="https://github.com/namtpham/casia1groundtruth" target="_blank" rel="noopener noreferrer">namtpham的仓库</a>Readme中的网盘链接下载原始数据集图片。</li><li>请clone该仓库以下载图片对应的mask<div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">git clone https://github.com/namtpham/casia1groundtruth</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul></li></ul><h3 id="组织数据集到imdl-benco可以读取的格式" tabindex="-1"><a class="header-anchor" href="#组织数据集到imdl-benco可以读取的格式"><span>组织数据集到IMDL-BenCo可以读取的格式</span></a></h3><p>具体格式要求请参考<a class="route-link" href="/IMDLBenCo-doc/zh/guide/quickstart/0_dataprepare.html">数据集准备章节</a>。</p><ul><li>下载好的CASIAv2数据集已经按照<code>ManiDataset</code>的格式组织了，解压后即可。</li><li>下载好的CASIAv1数据集还需要进一步处理。我们这里分别提供<code>JsonDataset</code>和<code>ManiDataset</code>两种方式。</li></ul><p>首先，对于该仓库提供的原始数据集<code>CASIA 1.0 dataset</code>解压后可以看到文件如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token builtin class-name">.</span></span>
<span class="line">├── Au.zip</span>
<span class="line">├── Authentic_list.txt</span>
<span class="line">├── Modified Tp.zip</span>
<span class="line">├── Modified_CopyMove_list.txt</span>
<span class="line">├── Modified_Splicing_list.txt</span>
<span class="line">├── Original Tp.zip</span>
<span class="line">├── Original_CopyMove_list.txt</span>
<span class="line">└── Original_Splicing_list.txt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为最早CASIA官方有一些文件名谬误，该仓库对于这些命名错误进行了修改。实际上我们只需要解压修改后的<code>Modified Tp.zip</code>即可，得到：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">└── Tp</span>
<span class="line">    ├── CM</span>
<span class="line">    └── Sp</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code>CM</code>下存放着<code>Copy-move</code>对应的篡改图像；而<code>SP</code>下存放着<code>Splicing</code>对应的篡改图像。理论上一共有921张图片。</p><div class="hint-container warning"><p class="hint-container-title">重要！</p><p>根据<a href="https://github.com/SunnyHaze/IML-Dataset-Corrections" target="_blank" rel="noopener noreferrer">勘误仓库</a>，这里存在一张多余的图片没有对应的mask，即：<code>CASIA1.0/Modified Tp/Tp/Sp/Sp_D_NRN_A_cha0011_sec0011_0542.jpg</code>我们建议将这张图从这个数据集去除掉再进行后续处理。</p></div><p>另外，对于存放对应mask的<code>CASIA 1.0 groundtruth</code>解压后得到：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token builtin class-name">.</span></span>
<span class="line">└── CASIA <span class="token number">1.0</span> groundtruth</span>
<span class="line">    ├── CM</span>
<span class="line">    ├── CopyMove_groundtruth_list.txt</span>
<span class="line">    ├── FileNameCorrection.xlsx</span>
<span class="line">    ├── Sp</span>
<span class="line">    └── Splicing_groundtruth_list.txt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同理，<code>CM</code>下存放着<code>Copy-move</code>对应的mask；而<code>SP</code>下存放着<code>Splicing</code>对应的mask。理论上应该有920张图片。<strong>所以为了保证image和mask能一一对应，请务必去除掉篡改图像中上述多余的一张</strong>。</p><p>接下来我们展示通过两种方式组织CASIAv1为IMDL-BenCo可以读取的数据集。</p><h4 id="以jsondataset为例组织数据集" tabindex="-1"><a class="header-anchor" href="#以jsondataset为例组织数据集"><span>以JsonDataset为例组织数据集</span></a></h4><p>通过在设置好的路径下执行如下Python脚本即可生成IMDL-BenCo可以读取的<code>JSON</code>文件：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> os</span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">collect_image_paths</span><span class="token punctuation">(</span>root_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;收集目录下所有图片文件的相对路径和绝对路径&quot;&quot;&quot;</span></span>
<span class="line">    image_exts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;.jpg&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.jpeg&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.png&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.bmp&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.tif&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.tiff&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.webp&#39;</span><span class="token punctuation">}</span></span>
<span class="line">    image_paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    pwd <span class="token operator">=</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> dirpath<span class="token punctuation">,</span> _<span class="token punctuation">,</span> filenames <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>root_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">for</span> filename <span class="token keyword">in</span> filenames<span class="token punctuation">:</span></span>
<span class="line">            file_ext <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> file_ext <span class="token keyword">in</span> image_exts<span class="token punctuation">:</span></span>
<span class="line">                abs_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>normpath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dirpath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                image_paths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>pwd<span class="token punctuation">,</span> abs_path<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> image_paths</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">generate_pairs</span><span class="token punctuation">(</span>image_root<span class="token punctuation">,</span> mask_root<span class="token punctuation">,</span> output_json<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 收集图片路径</span></span>
<span class="line">    image_dict <span class="token operator">=</span> collect_image_paths<span class="token punctuation">(</span>image_root<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;发现image数量:&quot;</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_dict<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    mask_dict <span class="token operator">=</span> collect_image_paths<span class="token punctuation">(</span>mask_root<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;发现的mask数量:&quot;</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mask_dict<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_dict<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mask_dict<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;图片数量为{}和掩码数量{}不匹配！&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>image_dict<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mask_dict<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 生成配对列表</span></span>
<span class="line">    pairs <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token builtin">list</span><span class="token punctuation">(</span>pairs<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">for</span> pairs <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>image_dict<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>mask_dict<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>pairs<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 保存为JSON文件</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>output_json<span class="token punctuation">,</span> <span class="token string">&#39;w&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>pairs<span class="token punctuation">,</span> f<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;成功生成 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>pairs<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 对路径，结果已保存至 </span><span class="token interpolation"><span class="token punctuation">{</span>output_json<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> pairs</span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 配置路径（根据实际情况修改）</span></span>
<span class="line">    IMAGE_ROOT <span class="token operator">=</span> <span class="token string">&quot;Tp&quot;</span></span>
<span class="line">    MASK_ROOT <span class="token operator">=</span> <span class="token string">&quot;CASIA 1.0 groundtruth&quot;</span></span>
<span class="line">    OUTPUT_JSON <span class="token operator">=</span> <span class="token string">&quot;CASIAv1.json&quot;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 执行生成</span></span>
<span class="line">    result_pairs <span class="token operator">=</span> generate_pairs<span class="token punctuation">(</span>IMAGE_ROOT<span class="token punctuation">,</span> MASK_ROOT<span class="token punctuation">,</span> OUTPUT_JSON<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 打印后5对示例以验证是否真的对齐了</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\n后五对示例配对：&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> pair <span class="token keyword">in</span> result_pairs<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Image: </span><span class="token interpolation"><span class="token punctuation">{</span>pair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Mask:  </span><span class="token interpolation"><span class="token punctuation">{</span>pair<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以我为例，生成了这样的<code>json</code>文件：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">[</span></span>
<span class="line">  <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;/mnt/data0/xiaochen/workspace/IMDLBenCo_pure/guide/Tp/CM/Sp_S_CND_A_pla0016_pla0016_0196.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;/mnt/data0/xiaochen/workspace/IMDLBenCo_pure/guide/CASIA 1.0 groundtruth/CM/Sp_S_CND_A_pla0016_pla0016_0196_gt.png&quot;</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">   ......</span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>后续通过将这个json文件的绝对路径作为测试集参数写入shell即可，比如：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">/mnt/data0/xiaochen/workspace/IMDLBenCo_pure/guide/CASIAv1.json</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>特别的，如果你后续自己构建的数据集有真图，则自行写脚本构建JSON的时候，需要向真图的<code>mask</code>的路径写入<code>Negative</code>这个字符串。这样<code>Benco</code>会将这张图看做真图，对应纯黑的mask。比如加入上面这张图想看做真图使用的话，json应该这样组织：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">[</span></span>
<span class="line">  <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;/mnt/data0/xiaochen/workspace/IMDLBenCo_pure/guide/Tp/CM/Sp_S_CND_A_pla0016_pla0016_0196.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;Negative&quot;</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">   ......</span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="以manidataset为例组织数据集" tabindex="-1"><a class="header-anchor" href="#以manidataset为例组织数据集"><span>以ManiDataset为例组织数据集</span></a></h4><p>十分简单，找一个干净的存放数据集的路径创建一个名为<code>CASIAv1</code>的文件夹，然后分别按照如下名字新建两个子文件夹：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">└── CASIAv1</span>
<span class="line">    ├── Tp</span>
<span class="line">    └── Gt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后将920张篡改图像拷贝到<code>Tp</code>路径下，将920张mask拷贝到<code>Gt</code>路径下即可。后续通过将这个文件夹的路径作为测试集参数写入shell即可，比如：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">/mnt/data0/xiaochen/workspace/IMDLBenCo_pure/guide/CASIAv1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="在benco-init下调整设计自己的模型。" tabindex="-1"><a class="header-anchor" href="#在benco-init下调整设计自己的模型。"><span>在benco init下调整设计自己的模型。</span></a></h3><p>首先，我们需要执行<code>benco init</code>生成所需的所有文件和脚本。在本章前半部分已经对生成的文件做了简要介绍。</p><p>自定义自己的模型，要修改<code>mymodel.py</code>，我们先给出修改后的代码，然后对重要的部分加以介绍。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> IMDLBenCo<span class="token punctuation">.</span>registry <span class="token keyword">import</span> MODELS</span>
<span class="line"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn</span>
<span class="line"><span class="token keyword">import</span> torch</span>
<span class="line"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F</span>
<span class="line"><span class="token keyword">import</span> timm</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ConvNeXtDecoder</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;适配ConvNeXt的特征解码器&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encoder_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">768</span><span class="token punctuation">]</span><span class="token punctuation">,</span> decoder_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 使用转置卷积逐步上采样</span></span>
<span class="line">        self<span class="token punctuation">.</span>decoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span></span>
<span class="line">            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>encoder_channels<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> decoder_channels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 16x16 -&gt; 64x64</span></span>
<span class="line">            nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            </span>
<span class="line">            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>decoder_channels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> decoder_channels<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 64x64 -&gt; 256x256</span></span>
<span class="line">            nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            </span>
<span class="line">            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>decoder_channels<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> decoder_channels<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            </span>
<span class="line">            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>decoder_channels<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> decoder_channels<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            </span>
<span class="line">            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>decoder_channels<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>decoder<span class="token punctuation">(</span>x<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@MODELS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyConvNeXt</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 初始化ConvNeXt-Tiny骨干网络</span></span>
<span class="line">        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> timm<span class="token punctuation">.</span>create_model<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&quot;convnext_tiny&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            features_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            out_indices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 取最后一个特征图 (1/32下采样)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 分割解码器</span></span>
<span class="line">        self<span class="token punctuation">.</span>seg_decoder <span class="token operator">=</span> ConvNeXtDecoder<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 分类头</span></span>
<span class="line">        self<span class="token punctuation">.</span>cls_head <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span></span>
<span class="line">            nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">768</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># ConvNeXt-Tiny最后通道数是768</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 损失函数</span></span>
<span class="line">        self<span class="token punctuation">.</span>seg_loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>cls_loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 特征提取</span></span>
<span class="line">        features <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取最后一个特征图 [B, 768, H/32, W/32]</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 分割预测</span></span>
<span class="line">        seg_pred <span class="token operator">=</span> self<span class="token punctuation">.</span>seg_decoder<span class="token punctuation">(</span>features<span class="token punctuation">)</span></span>
<span class="line">        seg_pred <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>seg_pred<span class="token punctuation">,</span> size<span class="token operator">=</span>mask<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">&#39;bilinear&#39;</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 分类预测</span></span>
<span class="line">        cls_pred <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_head<span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 计算损失</span></span>
<span class="line">        seg_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>seg_loss<span class="token punctuation">(</span>seg_pred<span class="token punctuation">,</span> mask<span class="token punctuation">)</span></span>
<span class="line">        cls_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_loss<span class="token punctuation">(</span>cls_pred<span class="token punctuation">,</span> label<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        combined_loss <span class="token operator">=</span> seg_loss <span class="token operator">+</span> cls_loss</span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 构建输出字典</span></span>
<span class="line">        output_dict <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;backward_loss&quot;</span><span class="token punctuation">:</span> combined_loss<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;pred_mask&quot;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>seg_pred<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;pred_label&quot;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>cls_pred<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">            <span class="token string">&quot;visual_loss&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;total_loss&quot;</span><span class="token punctuation">:</span> combined_loss<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;seg_loss&quot;</span><span class="token punctuation">:</span> seg_loss<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;cls_loss&quot;</span><span class="token punctuation">:</span> cls_loss</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">            <span class="token string">&quot;visual_image&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;pred_mask&quot;</span><span class="token punctuation">:</span> seg_pred<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> output_dict</span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 测试代码</span></span>
<span class="line">    model <span class="token operator">=</span> MyConvNeXt<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span></span>
<span class="line">    mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span></span>
<span class="line">    label <span class="token operator">=</span> torch<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 注意标签维度调整为[batch_size]</span></span>
<span class="line">    output <span class="token operator">=</span> model<span class="token punctuation">(</span>x<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> label<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">[</span><span class="token string">&quot;pred_mask&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>  <span class="token comment"># torch.Size([2, 1, 512, 512])</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">[</span><span class="token string">&quot;pred_label&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token comment"># torch.Size([2])</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先我们重命名了模型的类名为<code>class MyConvNeXt(nn.Module)</code>，只有完整模型的入口需要添加<code>@MODELS.register_module()</code>装饰器完成全局注册。前面的子模块<code>class ConvNeXtDecoder(nn.Module):</code>因为不需要被IMDL-BenCo直接调用，所以无需注册，也无需保持特别接口。</p><p>可以注意到，损失函数被定义在了<code>__init__()</code>函数内部，并且在<code>forward()</code>函数中计算了损失。</p><p>最后输出的字典，按照接口格式传回了：</p><ol><li><code>backward_loss</code>，损失函数；</li><li><code>pred_mask</code>，分割头的pixel-level的预测结果，是0~1的概率图，会自动用于计算pixel-level的所有指标，比如<code>pixel-level F1</code>；</li><li><code>pred_label</code>，分类头的image-level的预测结果，是0~1的概率值，会自动用于image-level的所有指标，比如<code>image-level AUC</code>；</li><li><code>visual_loss</code>，用于可视化的标量损失函数字典，按照每个Epoch数值变化给每个标量绘制折线图；</li><li><code>visual_image</code>，用于观察预测mask的预测tensor字典，通过tensorboard展示图片的API逐字段展示字典中所有包含的tensor。</li></ol><div class="hint-container important"><p class="hint-container-title">重要</p><p>这个字典是IMDL-BenCo自动化完成计算和可视化的重要接口，请务必掌握。</p></div><h3 id="修改其他脚本" tabindex="-1"><a class="header-anchor" href="#修改其他脚本"><span>修改其他脚本</span></a></h3><p>首先，因为修改了<code>mymodel.py</code>的一些信息，首先需要修改对应文件的接口。主要包含如下地方：</p><ul><li><code>train.py</code>, <code>test.py</code>和<code>test_robust.py</code>三个文件的开头关于模型的<code>import</code>修改为对应的模型名 <ul><li>原来是<code>from mymodel import MyModel</code>, 这里修改为新的模型名<code>from mymodel import MyConvNeXt</code></li><li>当然，如果你修改了<code>mymodel.py</code>的文件名也是可以的，保证对应的import一致即可。</li><li>如果不import，则后续训练时IMDL-BenCo会无法找到对应的模型。</li></ul></li></ul><div class="hint-container important"><p class="hint-container-title">重要的TODOs等你去修改</p><p><code>train.py</code>, <code>test.py</code>和<code>test_robust.py</code>三个文件中留有很多<code>TODO</code>注释，是鼓励各位主动进行修改的部分。</p><p>比如想要引入<code>Pixel-AUC</code>等指标也需要通过手动修改该位置的<code>TODO</code>实现。</p></div><hr><ul><li><code>train_mymodel.sh</code>这个脚本是启动训练的shell脚本，肯定需要修改。 <ul><li><code>--model</code>字段改为<code>MyConvNeXt</code>，模型会自动根据该字符串，从已经注册过的类匹配到对应模型。</li><li>因为这个模型的<code>__init__()</code>函数没有形参，所以这里作为样例展示的两个多余的参数<code>--MyModel_Customized_param</code>和<code>--pre_trained_weights</code>这两行直接删去即可。这个技术的文档在<a class="route-link" href="/IMDLBenCo-doc/zh/guide/quickstart/1_model_zoo.html#%E9%80%9A%E8%BF%87shell%E4%BC%A0%E5%85%A5nn-module%E7%9A%84%E8%B6%85%E5%8F%82%E6%95%B0-%E8%AF%AD%E6%B3%95%E7%B3%96">通过shell传入nn.module的超参数</a>章节。</li><li>修改<code>--data_path</code>字段为准备好的训练集路径。</li><li>修改<code>--test_data_path</code>字段为之前准备好的测试集路径</li><li>修改其他的训练超参数以匹配你的设备需求，运算效率等等。 以下是一个修改好的<code>train_mymodel.sh</code>的样例。</li></ul></li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token assign-left variable">base_dir</span><span class="token operator">=</span><span class="token string">&quot;./output_dir&quot;</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">${base_dir}</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">CUDA_VISIBLE_DEVICES</span><span class="token operator">=</span><span class="token number">0,1</span> <span class="token punctuation">\</span></span>
<span class="line">torchrun  <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--standalone</span>    <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--nnodes</span><span class="token operator">=</span><span class="token number">1</span>     <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--nproc_per_node</span><span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\</span></span>
<span class="line">./train.py <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--model</span> MyConvNeXt <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--world_size</span> <span class="token number">1</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--batch_size</span> <span class="token number">32</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--test_batch_size</span> <span class="token number">32</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--num_workers</span> <span class="token number">8</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--data_path</span> /mnt/data0/public_datasets/IML/CASIA2.0 <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--epochs</span> <span class="token number">200</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--lr</span> 1e-4 <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--image_size</span> <span class="token number">512</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--if_resizing</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--min_lr</span> 5e-7 <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--weight_decay</span> <span class="token number">0.05</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--edge_mask_width</span> <span class="token number">7</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--test_data_path</span> <span class="token string">&quot;/mnt/data0/public_datasets/IML/CASIA1.0&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--warmup_epochs</span> <span class="token number">2</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--output_dir</span> <span class="token variable">${base_dir}</span>/ <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--log_dir</span> <span class="token variable">${base_dir}</span>/ <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--accum_iter</span> <span class="token number">8</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--seed</span> <span class="token number">42</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--test_period</span> <span class="token number">4</span> <span class="token punctuation">\</span></span>
<span class="line"><span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token variable">${base_dir}</span>/error.log <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token variable">${base_dir}</span>/logs.log</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我有两张显卡，所以设置<code>CUDA_VISIBLE_DEVICES=0,1</code>和<code>--nproc_per_node=2</code>，你可以修改为你设备可以支持的数量和对应显卡编号。</p><h3 id="开展训练" tabindex="-1"><a class="header-anchor" href="#开展训练"><span>开展训练</span></a></h3><p>然后在该工作目录下执行如下指令即可开始训练：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">sh</span> train_mymodel.sh</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>发现没有输出，不要慌张，为了保存日志，<strong>所有的输出和报错均被重定向到了文件。</strong></p><p>如果正确运行，则会在当前路径下生成一个名为<code>output_dir_xxx</code>或者<code>eval_dir_xxx</code>的文件夹，该文件夹内输出了三个日志，一个是正常的标准输出<code>logs.log</code>，一个是警告和报错<code>error.log</code>。还有一个独立的专门统计标量的<code>log.txt</code></p><p>如果模型运行正常，则应该可以在<code>logs.log</code>末尾看到模型不断地迭代输出新的日志：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token punctuation">[</span>01:51:01.408908<span class="token punctuation">]</span> Epoch: <span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">]</span> Total time: <span class="token number">0</span>:00:47 <span class="token punctuation">(</span><span class="token number">0.5883</span> s / it<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">[</span>01:51:08.313768<span class="token punctuation">]</span> Averaged stats: lr: <span class="token number">0.000051</span>  total_loss: <span class="token number">0.0379</span> <span class="token punctuation">(</span><span class="token number">0.0425</span><span class="token punctuation">)</span>  seg_loss: <span class="token number">0.0379</span> <span class="token punctuation">(</span><span class="token number">0.0425</span><span class="token punctuation">)</span>  cls_loss: <span class="token number">0.0000</span> <span class="token punctuation">(</span><span class="token number">0.0000</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">[</span>01:51:08.319097<span class="token punctuation">]</span> log_dir: ./output_dir/</span>
<span class="line"><span class="token punctuation">[</span>01:51:12.473905<span class="token punctuation">]</span> Epoch: <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>  <span class="token punctuation">[</span> <span class="token number">0</span>/80<span class="token punctuation">]</span>  eta: <span class="token number">0</span>:05:32  lr: <span class="token number">0.000051</span>  total_loss: <span class="token number">0.0415</span> <span class="token punctuation">(</span><span class="token number">0.0415</span><span class="token punctuation">)</span>  seg_loss: <span class="token number">0.0415</span> <span class="token punctuation">(</span><span class="token number">0.0415</span><span class="token punctuation">)</span>  cls_loss: <span class="token number">0.0000</span> <span class="token punctuation">(</span><span class="token number">0.0000</span><span class="token punctuation">)</span>  time: <span class="token number">4.1538</span>  data: <span class="token number">2.5060</span>  max mem: <span class="token number">12775</span></span>
<span class="line"><span class="token punctuation">[</span>01:51:23.468235<span class="token punctuation">]</span> Epoch: <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token number">20</span>/80<span class="token punctuation">]</span>  eta: <span class="token number">0</span>:00:43  lr: <span class="token number">0.000051</span>  total_loss: <span class="token number">0.0383</span> <span class="token punctuation">(</span><span class="token number">0.0426</span><span class="token punctuation">)</span>  seg_loss: <span class="token number">0.0383</span> <span class="token punctuation">(</span><span class="token number">0.0426</span><span class="token punctuation">)</span>  cls_loss: <span class="token number">0.0000</span> <span class="token punctuation">(</span><span class="token number">0.0000</span><span class="token punctuation">)</span>  time: <span class="token number">0.5496</span>  data: <span class="token number">0.0083</span>  max mem: <span class="token number">12775</span></span>
<span class="line"><span class="token punctuation">[</span>01:51:34.303514<span class="token punctuation">]</span> Epoch: <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token number">40</span>/80<span class="token punctuation">]</span>  eta: <span class="token number">0</span>:00:25  lr: <span class="token number">0.000051</span>  total_loss: <span class="token number">0.0354</span> <span class="token punctuation">(</span><span class="token number">0.0406</span><span class="token punctuation">)</span>  seg_loss: <span class="token number">0.0354</span> <span class="token punctuation">(</span><span class="token number">0.0406</span><span class="token punctuation">)</span>  cls_loss: <span class="token number">0.0000</span> <span class="token punctuation">(</span><span class="token number">0.0000</span><span class="token punctuation">)</span>  time: <span class="token number">0.5417</span>  data: <span class="token number">0.0002</span>  max mem: <span class="token number">12775</span></span>
<span class="line"><span class="token punctuation">[</span>01:51:45.128389<span class="token punctuation">]</span> Epoch: <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token number">60</span>/80<span class="token punctuation">]</span>  eta: <span class="token number">0</span>:00:12  lr: <span class="token number">0.000050</span>  total_loss: <span class="token number">0.0304</span> <span class="token punctuation">(</span><span class="token number">0.0401</span><span class="token punctuation">)</span>  seg_loss: <span class="token number">0.0304</span> <span class="token punctuation">(</span><span class="token number">0.0401</span><span class="token punctuation">)</span>  cls_loss: <span class="token number">0.0000</span> <span class="token punctuation">(</span><span class="token number">0.0000</span><span class="token punctuation">)</span>  time: <span class="token number">0.5412</span>  data: <span class="token number">0.0002</span>  max mem: <span class="token number">12775</span></span>
<span class="line"><span class="token punctuation">[</span>01:51:55.408163<span class="token punctuation">]</span> Epoch: <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token number">79</span>/80<span class="token punctuation">]</span>  eta: <span class="token number">0</span>:00:00  lr: <span class="token number">0.000050</span>  total_loss: <span class="token number">0.0366</span> <span class="token punctuation">(</span><span class="token number">0.0394</span><span class="token punctuation">)</span>  seg_loss: <span class="token number">0.0366</span> <span class="token punctuation">(</span><span class="token number">0.0394</span><span class="token punctuation">)</span>  cls_loss: <span class="token number">0.0000</span> <span class="token punctuation">(</span><span class="token number">0.0000</span><span class="token punctuation">)</span>  time: <span class="token number">0.5409</span>  data: <span class="token number">0.0001</span>  max mem: <span class="token number">12775</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>按照如上的设置，这个样例占用了两张显卡，每张卡占用<code>4104M</code>的显存。</p><p>这里推荐一个看显卡占用的工具<code>gpustat</code>，通过<code>pip install gpustat</code>后在命令行执行<code>gpustat</code>即可方便查看显卡占用以及对应用户。比如这里可以看到是我写这个教程时占用的前两张卡：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">psdz           Mon Mar <span class="token number">31</span> <span class="token number">22</span>:51:55 <span class="token number">2025</span>  <span class="token number">570.124</span>.06</span>
<span class="line"><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> NVIDIA A40 <span class="token operator">|</span> <span class="token number">44</span>°C, <span class="token number">100</span> % <span class="token operator">|</span> <span class="token number">18310</span> / <span class="token number">46068</span> MB <span class="token operator">|</span> psdz<span class="token punctuation">(</span>17442M<span class="token punctuation">)</span> gdm<span class="token punctuation">(</span>4M<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> NVIDIA A40 <span class="token operator">|</span> <span class="token number">45</span>°C,  <span class="token number">35</span> % <span class="token operator">|</span> <span class="token number">18310</span> / <span class="token number">46068</span> MB <span class="token operator">|</span> psdz<span class="token punctuation">(</span>17442M<span class="token punctuation">)</span> gdm<span class="token punctuation">(</span>4M<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> NVIDIA A40 <span class="token operator">|</span> <span class="token number">65</span>°C, <span class="token number">100</span> % <span class="token operator">|</span> <span class="token number">40153</span> / <span class="token number">46068</span> MB <span class="token operator">|</span> xuekang<span class="token punctuation">(</span>38666M<span class="token punctuation">)</span> xuekang<span class="token punctuation">(</span>482M<span class="token punctuation">)</span> xuekang<span class="token punctuation">(</span>482M<span class="token punctuation">)</span> xuekang<span class="token punctuation">(</span>482M<span class="token punctuation">)</span> gdm<span class="token punctuation">(</span>4M<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> NVIDIA A40 <span class="token operator">|</span> <span class="token number">76</span>°C, <span class="token number">100</span> % <span class="token operator">|</span> <span class="token number">38602</span> / <span class="token number">46068</span> MB <span class="token operator">|</span> xuekang<span class="token punctuation">(</span>38452M<span class="token punctuation">)</span> gdm<span class="token punctuation">(</span>108M<span class="token punctuation">)</span> gdm<span class="token punctuation">(</span>14M<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> NVIDIA A40 <span class="token operator">|</span> <span class="token number">59</span>°C, <span class="token number">100</span> % <span class="token operator">|</span> <span class="token number">38466</span> / <span class="token number">46068</span> MB <span class="token operator">|</span> xuekang<span class="token punctuation">(</span>38444M<span class="token punctuation">)</span> gdm<span class="token punctuation">(</span>4M<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> NVIDIA A40 <span class="token operator">|</span> <span class="token number">63</span>°C, <span class="token number">100</span> % <span class="token operator">|</span> <span class="token number">38478</span> / <span class="token number">46068</span> MB <span class="token operator">|</span> xuekang<span class="token punctuation">(</span>38456M<span class="token punctuation">)</span> gdm<span class="token punctuation">(</span>4M<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时可以通过执行下列指令调出<code>tensorboard</code>来监视训练过程:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">tensorboard <span class="token parameter variable">--logdir</span> ./  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>打开它给出的对应网址，如果你用的是服务器，vscode或者pycharm都会帮你把这个端口转发到你本地计算机的对应端口。按住ctrl单击对应链接即可。我这里是访问</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">http://localhost:6006/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>在Tensorboard中，我们可以看到很多有用的指标，可以监测训练过程和模型的收敛情况。它们全部和<code>my_model.py</code>中模型的<code>forward()</code>函数返回的字典中的信息对应。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 构建输出字典</span></span>
<span class="line">        output_dict <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;backward_loss&quot;</span><span class="token punctuation">:</span> combined_loss<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;pred_mask&quot;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>seg_pred<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;pred_label&quot;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>cls_pred<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">            <span class="token string">&quot;visual_loss&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;total_loss&quot;</span><span class="token punctuation">:</span> combined_loss<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;seg_loss&quot;</span><span class="token punctuation">:</span> seg_loss<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;cls_loss&quot;</span><span class="token punctuation">:</span> cls_loss</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">            <span class="token string">&quot;visual_image&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;pred_mask&quot;</span><span class="token punctuation">:</span> seg_pred<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> output_dict</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>损失函数的可视化对应<code>visual_loss</code>字段对应的字典:</p><p><img src="/IMDLBenCo-doc/images/training/training_loss.png" alt=""></p><p>评价指标的计算来自于<code>pred_mask</code>和<code>pred_label</code>的结果和<code>mask</code>计算得到：</p><p><img src="/IMDLBenCo-doc/images/training/pixelF1.png" alt="alt text"></p><p>可视化的预测结果，由<code>visual_image</code>字段得到，且默认输入的<code>image</code>，<code>mask</code>等图像也会自动被可视化输出，用于直接观察模型当前预测不好的地方在哪，方便进一步改进模型。</p><p><img src="/IMDLBenCo-doc/images/training/train_test_samples.png" alt=""></p><div class="hint-container note"><p class="hint-container-title">注意</p><p>教程这里应该有图片样例，如果没看到图片，请检查网络连接或开启VPN。</p></div><p>所有训练后得到的权重（Checkpoint）都保存在了训练<code>train_mymodel.sh</code>脚本开头的<code>base_dir</code>所对应的路径中。相应的<code>Tensorboard</code>的日志文件也保存在这里，以供后续取用和查阅日志。</p><p>除了Tensorboard日志，我们还提供了一个纯文本的日志<code>log.txt</code>留作档案，它保存的内容比较简单，只包含每一个Epoch结束后所有的标量信息。样例如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">......</span>
<span class="line">{&quot;train_lr&quot;: 5.068414063259753e-05, &quot;train_total_loss&quot;: 0.040027402791482446, &quot;train_seg_loss&quot;: 0.04001608065957309, &quot;train_cls_loss&quot;: 1.1322131909352606e-05, &quot;test_pixel-level F1&quot;: 0.6269838496863315, &quot;epoch&quot;: 100}</span>
<span class="line">{&quot;train_lr&quot;: 4.9894792537480576e-05, &quot;train_total_loss&quot;: 0.03938291078949974, &quot;train_seg_loss&quot;: 0.039372251576574625, &quot;train_cls_loss&quot;: 1.0659212925112626e-05, &quot;epoch&quot;: 101}</span>
<span class="line">{&quot;train_lr&quot;: 4.910553386394297e-05, &quot;train_total_loss&quot;: 0.039195733024078264, &quot;train_seg_loss&quot;: 0.039184275720948555, &quot;train_cls_loss&quot;: 1.1457303129702722e-05, &quot;epoch&quot;: 102}</span>
<span class="line">{&quot;train_lr&quot;: 4.8316563303634596e-05, &quot;train_total_loss&quot;: 0.0385435631179897, &quot;train_seg_loss&quot;: 0.03853294577689024, &quot;train_cls_loss&quot;: 1.061734109946144e-05, &quot;epoch&quot;: 103}</span>
<span class="line">{&quot;train_lr&quot;: 4.752807947567499e-05, &quot;train_total_loss&quot;: 0.035692626619510615, &quot;train_seg_loss&quot;: 0.03568181328162471, &quot;train_cls_loss&quot;: 1.0813337885906548e-05, &quot;test_pixel-level F1&quot;: 0.6672104743469334, &quot;epoch&quot;: 104}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>模型每4个Epoch测试一次，所以只有对应的epoch才会保存<code>test_pixel-level F1</code>。</p><p>至此，我们就解释完了所有训练过程中的输出内容。</p><h3 id="开展测试" tabindex="-1"><a class="header-anchor" href="#开展测试"><span>开展测试</span></a></h3><p>我们在前面的指标测试中看到在104Epoch时，模型还有上涨趋势，但为了节约时间，我们将训练停在这里，开展后续的测试。</p><p>篡改检测数据集之间的鸿沟较大，泛化性能是衡量模型性能最重要的指标，所以我们希望一次性测量所有指标。区别于前面的教程，我们要用到一次性可以涵盖多个测试集的<code>test_datasets.json</code>文件来帮助测试。其格式如下，我们也在<code>benco init</code>后的文件中提供了此文件的样例。</p><div class="language-JSON line-numbers-mode" data-highlighter="prismjs" data-ext="JSON"><pre><code><span class="line">{</span>
<span class="line">    &quot;Columbia&quot;: &quot;/mnt/data0/public_datasets/IML/Columbia.json&quot;,</span>
<span class="line">    &quot;NIST16_1024&quot;: &quot;/mnt/data0/public_datasets/IML/NIST16_1024&quot;,</span>
<span class="line">    &quot;NIST16_cleaned&quot;: &quot;/mnt/data0/public_datasets/IML/NIST16_1024_cleaning&quot;,</span>
<span class="line">    &quot;coverage&quot;: &quot;/mnt/data0/public_datasets/IML/coverage.json&quot;,</span>
<span class="line">    &quot;CASIAv1&quot;: &quot;/mnt/data0/public_datasets/IML/CASIA1.0&quot;,</span>
<span class="line">    &quot;IMD20_1024&quot;: &quot;/mnt/data0/public_datasets/IML/IMD_20_1024&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里需要您预先处理好每一个数据集，数据集索引在<a class="route-link" href="/IMDLBenCo-doc/zh/imdl_data_model_hub/data/IMDLdatasets.html">篡改检测数据集索引</a>章节，格式要求在<a class="route-link" href="/IMDLBenCo-doc/zh/guide/quickstart/0_dataprepare.html">数据集准备章节</a>。上述路径必须整理为<code>ManiDataset</code>或者<code>JsonDataset</code>的格式。，</p><p>然后我们修改<code>test_mymodel.sh</code>文件来传入正确的参数，主要包含如下字段：</p><ul><li><code>--mymodel</code> 改为<code>MyConvNeXt</code></li><li>去掉多余的<code>--MyModel_Customized_param</code> 和 <code>--pre_trained_weights</code>尤其是<code>pretrained_path</code>一般是在模型训练前初始化的。测试阶段无关。</li><li>将<code>--checkpoint_path</code>设置为训练时输出所有<code>checkpoint-xx.pth</code>的文件夹。它会自动读取这下面所有的以<code>.pth</code>结尾的文件，并根据文件名中的数字确认该checkpoint来自于第几个epoch以正确的绘制测试时的指标折线图。</li><li>将<code>--test_data_json</code>设置为前文含有多个测试集信息的JSON的路径。</li><li>其它参数按照显存等条件要求，酌情设置即可，</li></ul><div class="hint-container important"><p class="hint-container-title">注意</p><p>如果你在训练时选择了<code>--if_padding</code>，这代表dataloader会将所有图像按照<a href="https://github.com/SunnyHaze/IML-ViT" target="_blank" rel="noopener noreferrer">IML-ViT</a>的0-padding方式组织，而非大多数模型的<code>--if_resizing</code>。那一定要确认测试时该参数与训练时保持一致，否则训练集和测试集不一致，一定会有性能损失。</p><p>可以通过Tensorboard可视化的图片双重检查是否正确选择padding或者resizing！</p></div><p>一个修改好的<code>test_mymodel.sh</code>如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token assign-left variable">base_dir</span><span class="token operator">=</span><span class="token string">&quot;./eval_dir&quot;</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">${base_dir}</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">CUDA_VISIBLE_DEVICES</span><span class="token operator">=</span><span class="token number">0,1</span> <span class="token punctuation">\</span></span>
<span class="line">torchrun  <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--standalone</span>    <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--nnodes</span><span class="token operator">=</span><span class="token number">1</span>     <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--nproc_per_node</span><span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\</span></span>
<span class="line">./test.py <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--model</span> MyConvNeXt <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--world_size</span> <span class="token number">1</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--test_data_json</span> <span class="token string">&quot;./test_datasets.json&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--checkpoint_path</span> <span class="token string">&quot;./output_dir/&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--test_batch_size</span> <span class="token number">32</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--image_size</span> <span class="token number">512</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--if_resizing</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--output_dir</span> <span class="token variable">${base_dir}</span>/ <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--log_dir</span> <span class="token variable">${base_dir}</span>/ <span class="token punctuation">\</span></span>
<span class="line"><span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token variable">${base_dir}</span>/error.log <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token variable">${base_dir}</span>/logs.log</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，记得修改<code>test.py</code>开头的<code>from mymodel import MyModel</code>为<code>from mymodel import MyConvNeXt</code>。</p><p>此时，运行如下指令即可开始批量在各种测试集上测试指标：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">sh</span> test_mymodel.sh</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>此时也可以通过Tensorboard来查看测试进度和结果。可以在左侧的<code>filter</code>框过滤<code>eval_dir</code>来仅查看此次测试的输出结果。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">tensorboard <span class="token parameter variable">--logdir</span> ./</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>测试后得到的多个数据集的指标折线图如下，选择综合性能最好的Checkpoint，并在论文中记录相应的数据即可。</p><p><img src="/IMDLBenCo-doc/images/training/testing_results.png" alt=""></p><h3 id="鲁棒性测试" tabindex="-1"><a class="header-anchor" href="#鲁棒性测试"><span>鲁棒性测试</span></a></h3><p>鲁棒性测试因为对于“攻击类型”和“攻击强度”引入了两个维度进行网格搜索（<code>gird search</code>），所以一般只对测试阶段性能最好的那一个checkpoint进行鲁棒性测试。</p><p>所以相应的<code>test_robust_mymodel.sh</code>文件中，区别于<code>test_mymodel.sh</code>，这里的<code>--checkpoint_path</code>字段填入的路径指向一个具体的checkpoint，而非一个文件夹。</p><p>其他的字段同上，去掉无用的参数，填入需要的参数，并且记得修改<code>test_robust.py</code>开头的<code>from mymodel import MyModel</code>为<code>from mymodel import MyConvNeXt</code>。</p><p>我最终使用的<code>test_robust_mymodel.sh</code>如下</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token assign-left variable">base_dir</span><span class="token operator">=</span><span class="token string">&quot;./eval_robust_dir&quot;</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">${base_dir}</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">CUDA_VISIBLE_DEVICES</span><span class="token operator">=</span><span class="token number">0,1</span> <span class="token punctuation">\</span></span>
<span class="line">torchrun  <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--standalone</span>    <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--nnodes</span><span class="token operator">=</span><span class="token number">1</span>     <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--nproc_per_node</span><span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\</span></span>
<span class="line">./test_robust.py <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--model</span> MyConvNeXt <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--world_size</span> <span class="token number">1</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--test_data_path</span> <span class="token string">&quot;/mnt/data0/public_datasets/IML/CASIA1.0&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--checkpoint_path</span> <span class="token string">&quot;/mnt/data0/xiaochen/workspace/IMDLBenCo_pure/guide/benco/output_dir/checkpoint-92.pth&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--test_batch_size</span> <span class="token number">32</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--image_size</span> <span class="token number">512</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--if_resizing</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--output_dir</span> <span class="token variable">${base_dir}</span>/ <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--log_dir</span> <span class="token variable">${base_dir}</span>/ <span class="token punctuation">\</span></span>
<span class="line"><span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token variable">${base_dir}</span>/error.log <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token variable">${base_dir}</span>/logs.log</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>鲁棒性测试具体的攻击策略和强度的调整需要修改<code>test_robust.py</code>，请通过搜索<code>TODO</code>来定位到这段可以修改的代码：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;=================================================</span>
<span class="line">    Modify here to Set the robustness test parameters TODO</span>
<span class="line">    ===================================================&quot;&quot;&quot;</span></span>
<span class="line">    robustness_list <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">            GaussianBlurWrapper<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            GaussianNoiseWrapper<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">            JpegCompressionWrapper<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这些<code>wrapper</code>后面的列表代表具体攻击的强度，他们内部封装了<a href="https://github.com/albumentations-team/albumentations" target="_blank" rel="noopener noreferrer">Albumentation</a>提供的Transform来实现攻击。<code>wrapper</code>本身的实现请参考此<a href="https://github.com/scu-zjz/IMDLBenCo/blob/main/IMDLBenCo/transforms/robustness_wrapper.py" target="_blank" rel="noopener noreferrer">链接</a>。</p><p>特别的，你可以在当前路径下参考源码中<code>wrapper</code>的实现封装新的自定义<code>wrapper</code>，然后像<code>from mymodel import MyConvNeXt</code>一样import你自己的wrapper到这里使用。这样无需修改源码，也能实现自定义灵活的鲁棒性测试。</p><hr><p>对于测试结果，同样的，你可以通过Tensorboard查看：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">tensorboard <span class="token parameter variable">--logdir</span> ./</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这时候可能会产生很多很多不同的记录，请活用Tensorboard左上角的filter功能，过滤你当前需要记录的攻击类型和响应的结果。</p><p><img src="/IMDLBenCo-doc/images/training/robustness_test_plot.png" alt=""></p><hr><h3 id="结语" tabindex="-1"><a class="header-anchor" href="#结语"><span>结语</span></a></h3><p>这样我们就完成了一次从头到尾自己设计模型，训练模型，完成测试及鲁棒性测试的过程。有任何疑惑或者不完善的地方，欢迎向我们的仓库提issue或者给作者团队发邮件联系。第一手用户的建议对我们，以及对今后的学者帮助都会很大！</p><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;"><div style="display: flex;
align-items: center;
justify-content: center;
height: 96px"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);
--icon-size: 48px;
display: inline-block;
width: var(--icon-size);
height: var(--icon-size);
background-color: currentcolor;
-webkit-mask-image: var(--loading-icon);
mask-image: var(--loading-icon);
"></span></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link label" href="https://github.com/scu-zjz/IMDLBenCo-doc/edit/main/docs/zh/guide/quickstart/3_demo.md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><svg class="edit-icon" viewbox="0 0 1024 1024"><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]--><!--]-->在 GitHub 上编辑此页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">上次更新: </span><time class="meta-item-info" datetime="2025-04-03T10:12:18.000Z" data-allow-mismatch>2025/4/3 10:12</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: mxch1122@126.com">Ma Xiaochen (马晓晨)</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/IMDLBenCo-doc/zh/guide/quickstart/2_load_ckpt.html" aria-label="案例二：使用Model Zoo配合checkpoint快速测试"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">案例二：使用Model Zoo配合checkpoint快速测试</span></div><!--]--></a><a class="route-link auto-link next" href="/IMDLBenCo-doc/zh/guide/quickstart/4_save_images.html" aria-label="案例四：推理并保存一个数据集的mask和label"><!--[--><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span class="external-link">案例四：推理并保存一个数据集的mask和label</span></div><!--]--></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/IMDLBenCo-doc/assets/app-CCtLKDl1.js" defer></script>
  </body>
</html>
